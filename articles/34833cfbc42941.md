---
title: "Redux Toolkit Ã— RTK Query Ã— GraphQLã§ToDoã‚’è©¦ã—ã¦ã¿ã‚‹"
emoji: "ğŸƒ"
type: "tech"
topics: ["react", "typescript", "redux"]
published: true
---

ã“ã‚Œã¾ã§GraphQLã§ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚§ãƒƒãƒåŠã³ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æ‰±ã†å ´åˆã€[Apollo Client](https://github.com/apollographql/apollo-client)ã‚„[urql](https://github.com/FormidableLabs/urql)ãŒä¸»ãªå€™è£œã¨ã—ã¦æŒ™ãŒã£ã¦ã„ã¾ã—ãŸã€‚
ã—ã‹ã—Redux Tookit v1.6.0ã§RTK QueryãŒçµ„ã¿è¾¼ã¾ã‚Œã€GraphQLã‚’ç”¨ã„ãŸãƒ‡ãƒ¼ã‚¿ãƒ•ã‚§ãƒƒãƒã‚‚æƒ³å®šã•ã‚Œã¦ã„ã¾ã™ã€‚Reduxã‚’ç”¨ã„ã‚‹ã‚ˆã†ãªè¤‡é›‘ãªçŠ¶æ…‹ç®¡ç†ã¨ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ãŒå¿…è¦ã«ãªã‚‹ã‚±ãƒ¼ã‚¹ã§å„ªç§€ãªé¸æŠè‚¢ã«ãªã‚Šãã†ãªã®ã§ã€ToDoã‚¢ãƒ—ãƒªã§ä½¿ç”¨æ„Ÿã‚’è©¦ã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

## å‚è€ƒ

ä»Šå›ã¯ä¸€éƒ¨å…¬å¼ã®GraphQL Exampleã‚’å‚è€ƒã«ã—ã¦ã„ã¾ã™ã€‚

https://redux-toolkit.js.org/rtk-query/usage/examples

## äº‹å‰æº–å‚™

ä»Šå›ã¯GraphQLã‚’ä½¿ç”¨ã™ã‚‹ã®ã§Schemaã¨ãƒ¢ãƒƒã‚¯ã‚µãƒ¼ãƒãƒ¼ã‚’ç”¨æ„ã—ã¾ã™ã€‚
ã‚¿ã‚¤ãƒˆãƒ«ã®ã¿ã‚’æŒã¤ToDoã‚’å–å¾—ãƒ»ä½œæˆã§ãã‚‹ã‚·ãƒ³ãƒ—ãƒ«ãªToDoã§ã™ã€‚
ãƒ¢ãƒƒã‚¯ã‚µãƒ¼ãƒãƒ¼ã‚’ç”¨ã„ã‚‹å ´åˆç·¨é›†ãƒ»å®Œäº†ãƒ»å‰Šé™¤ç­‰ã®æ©Ÿèƒ½ã¯ã»ã¨ã‚“ã©ä½œæˆæ©Ÿèƒ½ã®ã‚³ãƒ¼ãƒ‰ã‚’è¤‡è£½ã™ã‚‹å½¢ã«ãªã‚ŠãŒã¡ãªã®ã§ã€ä»Šå›ã¯å‰²æ„›ã—ã¾ã™ã€‚

```graphql:schema.graphql
type ToDo {
  id: String!
  title: String!
}

type Query {
  toDos: [ToDo!]!
}

type Mutation {
  newToDo(title: String!): ToDo
}
```

[apollo-server](https://github.com/apollographql/apollo-server)ã§ãƒ¢ãƒƒã‚¯ã‚µãƒ¼ãƒãƒ¼ã‚’ç«‹ã¡ä¸Šã’ã¦ãŠãã¾ã™ã€‚ToDoã‚’è©¦ã™ã ã‘ã®ãƒ¢ãƒƒã‚¯ã‚µãƒ¼ãƒãƒ¼ãªã®ã§corsã¯'no-cors'ã‚’æŒ‡å®šã—ã¦ãŠãã¾ã™ã€‚

```ts:mock.ts
const { ApolloServer, makeExecutableSchema } = require('apollo-server')
const casual = require('casual')
const { importSchema } = require('graphql-import')

const typeDefs = importSchema('schema/schema.graphql');
const PORT = 4000;

const server = new ApolloServer({
  schema: makeExecutableSchema({
    typeDefs
  }),
  mocks: {
    Todo: () => ({
      id: casual.uuid,
      title: casual.title
    })
  },
  fetchOptions: {
    mode: 'no-cors',
  },
});

server.listen({ port: PORT }).then(({ url }) => {
  console.log(`ğŸš€ Server ready at ${url}`);
});
```

ä»¥ä¸Šã§Schemaã¨ãƒ¢ãƒƒã‚¯ã‚µãƒ¼ãƒãƒ¼ã®æº–å‚™ã¯å®Œäº†ã§ã™ã€‚

## ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰

### ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆ

ä»Šå›ã¯ToDoã‚’è©¦ã™ç›®çš„ãªã®ã§ã€create-react-appã®reduxãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½¿ã£ã¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ç«‹ã¡ä¸Šã’ã¾ã™ã€‚

```bash
npx create-react-app rtk-query-graphql-todo --template redux-typescript
```

### APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ

ã¾ãšã¯GraphQLãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¡Œã†ãŸã‚ã®baseQueryã‚’ä½œæˆã—ã¾ã™ã€‚
ä»Šå›ã¯å…¬å¼ã®ã‚µãƒ³ãƒ—ãƒ«é€šã‚Š`graphql-request`ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

```bash
yarn add graphql graphql-request
```

å®Ÿéš›ã®ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã§ã¯ã“ã®BaseQueryã‚’å¤‰æ›´ã—ã¦authorizationãƒ˜ãƒƒãƒ€ãƒ¼ãªã©ã‚’çµ„ã¿è¾¼ã‚“ã ã‚Šã€è‰²ã€…ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã™ã‚‹ã“ã¨ã«ãªã‚Šãã†ã§ã™ã€‚

```ts:baseQuery.ts
import { BaseQueryFn } from "@reduxjs/toolkit/dist/query";
import { DocumentNode } from "graphql";
import { ClientError, request } from "graphql-request";

export const graphqlBaseQuery =
  ({
    baseUrl,
  }: {
    baseUrl: string;
  }): BaseQueryFn<
    { document: string | DocumentNode; variables?: any },
    unknown,
    ClientError
  > =>
  async ({ document, variables }) => {
    try {
      return { data: await request(baseUrl, document, variables) };
    } catch (error) {
      if (error instanceof ClientError) {
        return { error };
      }
      throw error;
    }
  };
```

BaseQueryãŒå®Œæˆã—ãŸã®ã§ã€ToDoã®å–å¾—ç”¨queryã‚’å®šç¾©ã—ã¾ã™ã€‚
gqlé–¢æ•°ã‚’ç”¨ã„ã¦queryã‚’å®šç¾©ã—ã€getToDosã®documentã«æ¸¡ã—ã¾ã™ã€‚

```ts:toDo.ts
import { createApi } from "@reduxjs/toolkit/query/react";
import { gql } from "graphql-request";

import { graphqlBaseQuery } from "./baseQuery";

const getToDosDocument = gql`
  query getToDos {
    toDos {
      id
      title
    }
  }
`;

export const toDoApi = createApi({
  reducerPath: "toDoApi",
  baseQuery: graphqlBaseQuery({ baseUrl: "http://localhost:4000" }),
  endpoints: (builder) => ({
    getToDos: builder.query({
      query: () => ({
        document: getToDosDocument,
      }),
    }),
  }),
});

export const { useGetToDosQuery } = toDoApi;
```

ã“ã‚Œã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆç”¨ã®CustomHookãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚
ãŸã ã—ã€ã“ã®çŠ¶æ…‹ã ã¨å‹æƒ…å ±ãŒãªãã¦ä¸ä¾¿ãªã®ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å‰ã«å‹ã‚’ç”Ÿæˆã‚’ã—ã¾ã™ã€‚

### å‹ã®ç”Ÿæˆ

GraphQLã®Schemaã‹ã‚‰TypeScriptç”¨ã®å‹ã‚’ç”Ÿæˆã—ã¾ã™ã€‚
graphql-codegenã‚’ä½¿ç”¨ã™ã‚‹ã®ã§ã€å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’å°å…¥ã—ã¾ã™ã€‚

```bash
yarn add -D @graphql-codegen/cli @graphql-codegen/typescript @graphql-codegen/typescript-operations
```

graphql-codegenã‚’è¦‹ã¦ã¿ã‚‹ã¨RTK Queryç”¨ã®ã‚³ãƒ¼ãƒ‰ç”Ÿæˆã‚‚å­˜åœ¨ã™ã‚‹ã‚ˆã†ã§ã™ãŒã€ä»Šå›ã¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è©¦ã™ç›®çš„ãªã®ã§ä½¿ç”¨ã‚’è¦‹é€ã‚Šã¾ã™ã€‚

https://www.graphql-code-generator.com/docs/plugins/typescript-rtk-query

graphql-codegenç”¨ã®configãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”¨æ„ã—ã¾ã™ã€‚
ä»Šå›ã¯`src/services/`ä»¥ä¸‹ã«APIãƒªã‚¯ã‚¨ã‚¹ãƒˆç”¨ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ã„ã‚‹ã®ã§ä»¥ä¸‹ã®è¨­å®šã«ãªã£ã¦ã„ã¾ã™ã€‚
queryã®å‹ã‚’ç”Ÿæˆã™ã‚‹ãŸã‚ã«`documents`ã«ã¯å…ˆç¨‹`getToDos`ã‚’å®šç¾©ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’å«ã‚ã‚‹ã‚ˆã†ã«ã—ã¦ãŠãã¾ã™ã€‚

```yaml:graphql-codegen.yml
# å¸¸ã«ä¸Šæ›¸ã
overwrite: true
# ã‚¹ã‚­ãƒ¼ãƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ‡å®š
schema:
  - /schema/*.graphql:
generates:
  src/services/types.ts:
    documents: "src/services/**.ts"
    plugins:
      - typescript
      - typescript-operations
```

è¨­å®šãŒçµ‚ã‚ã£ãŸã®ã§ã€ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦å‹ã‚’ç”Ÿæˆã—ã¾ã™ã€‚
ã“ã®ã‚³ãƒãƒ³ãƒ‰ã¯ç°¡å˜ã«å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«npm scriptsã«ç™»éŒ²ã—ã¦ãŠãã¨è‰¯ã„ã¨æ€ã„ã¾ã™ã€‚

```
yarn graphql-codegen --config ./graphql-codegen.yml
```

ä»¥ä¸Šã§å‹ã®ç”ŸæˆãŒå®Œäº†ã—ãŸã®ã§ã€å…ˆç¨‹ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã«å‹ã‚’ä»˜ã‘ã¾ã™ã€‚

```diff ts:src/api/toDo.ts
 import { createApi } from "@reduxjs/toolkit/query/react";
+import { GetToDosQuery } from "./types";
 import { gql } from "graphql-request";

 import { graphqlBaseQuery } from "./baseQuery";

 const getToDosDocument = gql`
   query getToDos {
     toDos {
       id
       title
     }
   }
 `;

 export const toDoApi = createApi({
   reducerPath: "toDoApi",
   baseQuery: graphqlBaseQuery({ baseUrl: "http://localhost:4000" }),
   endpoints: (builder) => ({
-    getToDos: builder.query({
+    getToDos: builder.query<GetToDosQuery, void>({
       query: () => ({
         document: getToDosDocument,
       }),
     }),
   }),
 });

 export const { useGetToDosQuery } = toDoApi;
```

ã“ã‚Œã§ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¨queryã«æ¸¡ã™å¤‰æ•°ã®å‹ãŒä»˜ãã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

### storeã®è¨­å®š

storeã®ç”¨æ„ã‚’ã—ã¾ã™ã€‚
å…ˆç¨‹ç”Ÿæˆã—ãŸtoDoApiã‚’importã—ã¦reducerã«æ¸¡ã—ã¾ã™ã€‚
storeã®è¨­å®šã¯ä»¥ä¸Šã§å®Œäº†ã§ã™ã€‚ç°¡å˜ã§ã™ã­ã€‚

```ts:store.ts
import { configureStore, ThunkAction, Action } from "@reduxjs/toolkit";
import { toDoApi } from "../services/toDo";

export const store = configureStore({
  reducer: {
    [toDoApi.reducerPath]: toDoApi.reducer,
  },
  middleware: (getDefaultMiddleware) =>
    getDefaultMiddleware().concat(toDoApi.middleware),
});

export type AppDispatch = typeof store.dispatch;
export type RootState = ReturnType<typeof store.getState>;
export type AppThunk<ReturnType = void> = ThunkAction<
  ReturnType,
  RootState,
  unknown,
  Action<string>
>;
```

### ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ç¢ºèª

å¾Œã¯ç”Ÿæˆã•ã‚ŒãŸã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯ã‚’å‘¼ã³å‡ºã—ã¦APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¡Œã„ã¾ã™ã€‚

```tsx:app.tsx
import React from "react";
import { useGetToDosQuery } from "./services/toDo";

const App: React.FC = () => {
  const { data } = useGetToDosQuery();

  return (
    <div>
      ...
    </div>
  );
};

export default App;
```

ãƒ–ãƒ©ã‚¦ã‚¶ã¨Redux DevToolsã§ç¢ºèªã—ã¦ã¿ã‚‹ã¨ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒæˆåŠŸã—ã¦ã„ã‚‹ã“ã¨ã¨å„ç¨®å€¤ãŒStoreã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚
ãƒ•ã‚§ãƒƒãƒçŠ¶æ…‹ã‚„ã‚¨ãƒ©ãƒ¼ãŒè‡ªå‹•ã§æ›´æ–°ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã®ã§ã€ã“ã®ã‚ãŸã‚Šã®è¨˜è¿°ã‚’ã™ã‚‹æ‰‹é–“ãŒå¤§ããçœã‘ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/27e312598e4445d3034577c4.png)
![](https://storage.googleapis.com/zenn-user-upload/f6dbd3895671c66292a874b0.png)

### createToDo

ToDoã®å–å¾—ã«æˆåŠŸã—ãŸã®ã§æ¬¡ã¯ä½œæˆæ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¦ã„ãã¾ã™ã€‚
ã‚„ã‚‹ã“ã¨ã¯å–å¾—ã¨ã»ã¼åŒã˜ã§ã€toDoApiã«createToDoã‚’è¿½åŠ ã—ã¾ã™

```diff ts:src/api/toDo.ts
 import { createApi } from "@reduxjs/toolkit/query/react";
+import {
+  CreateToDoMutation,
+  CreateToDoMutationVariables,
+  GetToDosQuery,
+} from "./types";
 import { gql } from "graphql-request";

 ~~~
 
+const createToDoDocument = gql`
+mutation createToDo($title: String!) {
+  newToDo(title: $title) {
+    id
+    title
+  }
+}
+`;

 export const toDoApi = createApi({
   reducerPath: "toDoApi",
   baseQuery: graphqlBaseQuery({ baseUrl: "http://localhost:4000" }),
   endpoints: (builder) => ({
     getToDos: builder.query<GetToDosQuery, void>({
       query: () => ({
         document: getToDosDocument,
       }),
+    createToDo: builder.mutation<
+      CreateToDoMutation,
+      CreateToDoMutationVariables
+    >({
+      query: ({ title }) => ({
+        document: createToDoDocument,
+        variables: {
+          title,
+        },
      }),
    }),
   }),
 });

-export const { useGetToDosQuery } = toDoApi;
+export const { useGetToDosQuery, useCreateToDoMutation } = toDoApi;
```

ToDoä½œæˆç”¨ã®CustomHookãŒä½œæˆã•ã‚ŒãŸãŸã‚ã€Viewå´ã§å‘¼ã³å‡ºã—ã‚’è¡Œã„ã¾ã™ã€‚

```tsx:app.tsx
import React from "react";
import { useGetToDosQuery, useCreateToDoMutation } from "./services/toDo";

const App: React.FC = () => {
  const { data } = useGetToDosQuery();
  const [createToDo] = useCreateToDoMutation();

  return (
    <div>
      ...
      <button
        onClick={() => {
          createToDo({ title });
        }}
      >
        Create Todo
      </button>
    </div>
  );
};
```

å…¥åŠ›éƒ¨åˆ†ã®çŠ¶æ…‹ç®¡ç†ã¯å‰²æ„›ã—ã¾ã—ãŸãŒã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«é–¢ã—ã¦ã¯ã“ã‚Œã§å®Œäº†ã§ã™ã€‚
Redux DevToolsã‚’ç¢ºèªã™ã‚‹ã¨StoreãŒæ›´æ–°ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

ä»Šå›ã¯å®Ÿè£…ã—ã¾ã›ã‚“ã§ã—ãŸãŒã€RTK Queryã«ã¯è‡ªå‹•å†ãƒ•ã‚§ãƒƒãƒã‚„æ¥½è¦³çš„UIã®æ©Ÿèƒ½ç­‰ãŒæä¾›ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€ã“ã®ã‚ãŸã‚Šã®æ©Ÿèƒ½ã‚‚ç°¡å˜ã«å®Ÿè£…ã§ããã†ã§ã™ã€‚

https://redux-toolkit.js.org/rtk-query/usage/optimistic-updates

ä»¥ä¸Šã§Redux Toolkit Ã— RTK Query Ã— GraphQLã§ã‚·ãƒ³ãƒ—ãƒ«ãªToDoã®å®Ÿè£…ãŒã§ãã¾ã—ãŸã€‚

## ã•ã„ã”ã«

Apolloç­‰ã®æ—¢å­˜ã®GraphQLã®ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚§ãƒƒãƒãƒ©ã‚¤ãƒ–ãƒ©ãƒªå˜ä½“ã§ã¯ã€ä¸­è¦æ¨¡ã‚’è¶…ãˆã‚‹ã‚¢ãƒ—ãƒªã§æ±‚ã‚ã‚‰ã‚Œã‚‹ã‚ˆã†ãªè¤‡é›‘ãªçŠ¶æ…‹ç®¡ç†ã‚’å®Ÿè£…ã™ã‚‹ã®ã¯å³ã—ã„å°è±¡ãŒã‚ã‚Šã¾ã™ã€‚
å€‹äººçš„ã«ã¯ãã®ã‚ãŸã‚Šã‚’Redux Toolkitå˜ä½“ã§ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚§ãƒƒãƒã€œçŠ¶æ…‹ç®¡ç†ã¾ã§ã§ãã‚‹ã¨ã„ã„ãªãã¨æ€ã£ã¦ã„ã¾ã™ã€‚

RTK Queryã¯ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ»æ©Ÿèƒ½å…±ã«å……å®Ÿã—ã¦ã„ã‚‹ã®ã‚‚å¬‰ã—ã„ã¨ã“ã‚ã§ã™ã€‚
