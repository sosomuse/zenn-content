---
title: "CDKTFã®Terraform Stateã‚’Cloudflare R2ã§ç®¡ç†ã™ã‚‹"
emoji: "ğŸ”–"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["terraform", "cloudflare", "cdktf", "typescript"]
published: false
publication_name: "gemcook"
---

ã“ã‚“ã«ã¡ã¯ã€‚
å…ƒã€…ã¯ AWS ãƒ¡ã‚¤ãƒ³ã ã£ãŸã®ã§ã™ãŒã€æœ€è¿‘ä½•ã‹ã¨ Cloudflare ã‚’ä½¿ã†æ©Ÿä¼šãŒå¢—ãˆã¦ãã¾ã—ãŸã€‚

## æ¦‚è¦

æœ¬è¨˜äº‹ã§ã¯ CDKTFï¼ˆCloud Development Kit for Terraformï¼‰ ã® Terraform State ã‚’ Cloudflare R2 ã§ç®¡ç†ã™ã‚‹ãŸã‚ã«è©¦è¡ŒéŒ¯èª¤ã—ãŸã®ã§ã€ãã®æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚
å…ƒã€…ã¯ S3 ãƒã‚±ãƒƒãƒˆã« tfstate ã‚’ç½®ã„ã¦ã„ãŸã®ã§ã™ãŒã€ãã®ãŸã‚ã ã‘ã« AWS ç’°å¢ƒã‚’é–“å€Ÿã‚Šã™ã‚‹ã®ã‚‚ã‚‚ã£ãŸã„ãªã„ã®ã§ã€Cloudflare R2 ã«ç§»è¡Œã—ãŸã„ãªãƒ¼ã¨è€ƒãˆã¦ã„ã¾ã—ãŸã€‚

CDKTF ã‚„ Terraform ã®è§£èª¬ã¯å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
Cloudflare ãƒªã‚½ãƒ¼ã‚¹ã‚’ CDKTF ã§ç®¡ç†ã™ã‚‹æ–¹æ³•ã¯ç§ãŒä»¥å‰æ›¸ã„ãŸè¨˜äº‹ã‚’å‚è€ƒã«ã©ã†ãï¼ï¼ˆå®£ä¼ï¼‰

https://zenn.dev/gemcook/articles/0669e504ca38a7

## çµè«–

CDKTF ã® tfstate ã¯ Cloudflare R2 ã§ç®¡ç†ã§ãã‚‹ã€‚ä»¥ä¸‹ã®è¨­å®šãŒå¿…è¦

1. tfstate ç”¨ R2 ãƒã‚±ãƒƒãƒˆã‚’ä½œæˆ
2. `S3Backend` ã‚’ç¶™æ‰¿ã—ã¦ R2 ãƒã‚±ãƒƒãƒˆç”¨ã®ç‹¬è‡ªã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã‚’ä½œæˆ
3. Stack ã§ R2 ãƒã‚±ãƒƒãƒˆç”¨ã®ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã‚’å‘¼ã³å‡ºã™
4. tfstate ç”¨ R2 ãƒã‚±ãƒƒãƒˆã®èªè¨¼æƒ…å ±ã‚’è¨­å®š

## ãƒãƒ¼ã‚¸ãƒ§ãƒ³

Terraform,CDKTF ã®æ–°ã—ã‚ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ä½¿ã£ã¦ã„ã¾ã™ã€‚
ã“ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ä»¥å¤–ã§ã¯æœ¬è¨˜äº‹ã®ã‚³ãƒ¼ãƒ‰ã¯æ­£å¸¸ã«å‹•ä½œã—ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

- Terraform v1.8.5
- CDKTF v0.20.7

## tfstate ã¨ã¯

tfstate ã¨ã¯ Terraform ãŒç®¡ç†ã™ã‚‹ãƒªã‚½ãƒ¼ã‚¹ã®çŠ¶æ…‹ã‚’è¨˜éŒ²ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã§ã™ã€‚
ãƒãƒ¼ãƒ é–‹ç™ºã§è¤‡æ•°äººãŒåŒã˜ãƒªã‚½ãƒ¼ã‚¹ã‚’ç®¡ç†ã™ã‚‹å ´åˆã€tfstate ã‚’å…±æœ‰ã™ã‚‹ã“ã¨ã§ãƒªã‚½ãƒ¼ã‚¹ã®çŠ¶æ…‹ã‚’åŒæœŸã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
ã¤ã¾ã‚Šã“ã® tfstate ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã©ã“ã‹ã®ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜ã—ã¦ãŠãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

## Terraform ã§ã® tfstate ç®¡ç†

tfstate ã‚’ R2 ã§ç®¡ç†ã—ãŸã„ãªãƒ¼ã¨æ€ã£ã¦è‰²ã€…èª¿ã¹ã¦ã„ãŸã¨ã“ã‚ã€Terraformï¼ˆCDKTF ã§ã¯ãªã„ï¼‰ã§ tfstate ã‚’ R2 ã«ä¿å­˜ã™ã‚‹ãƒ•ãƒ¥ãƒ¼ãƒãƒ£ãƒ¼ã•ã‚“ã®è¨˜äº‹ã‚’è¦‹ã¤ã‘ã¾ã—ãŸã€‚

https://future-architect.github.io/articles/20231016a/

R2 ã¯ S3 äº’æ›ã®ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãªã®ã§ã€Terraform ã® S3Backend ã®å„ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã« R2 ã®å€¤ã‚’è¨­å®šã™ã‚‹ã“ã¨ã§ tfstate ã‚’ R2 ã«ä¿å­˜ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã¨ã„ã†ã“ã¨ã€‚ãªã‚‹ã»ã©ãƒ¼ï¼

Terraform ã§ã§ãã‚‹ãªã‚‰ CDKTF ã§ã‚‚ã§ãã‚‹ã¯ãšï¼ğŸ”¥
ã¨ã„ã†ã“ã¨ã§è©¦ã—ã¦ã¿ã¾ã—ãŸã€‚

## CDKTF ã§ã® tfstate ç®¡ç†

### R2 ãƒã‚±ãƒƒãƒˆä½œæˆ

ã¾ãšã¯ tfstate ã‚’ç®¡ç†ã™ã‚‹ãŸã‚ã® R2 ãƒã‚±ãƒƒãƒˆãŒå¿…è¦ãªã®ã§ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ä½œæˆã—ã¦ãŠãã¾ã™ã€‚

![](/images/cdktf-tfstate/example-tfstate.png)

### R2Backend ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã®ä½œæˆ

S3 ãƒã‚±ãƒƒãƒˆã§ tfstate ã‚’ç®¡ç†ã™ã‚‹ãŸã‚ã® `S3Backend` ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã‚’ç¶™æ‰¿ã—ã¦ã€R2 ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’æŒ‡å®šã™ã‚‹ `R2Backend` ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã‚’ä½œæˆã—ã¾ã™ã€‚

```ts:r2-backend.ts
import { S3Backend } from "cdktf";
import type { Construct } from "constructs";
import { CLOUDFLARE_ACCOUNT_ID } from "./constants";

export class R2Backend extends S3Backend {
  constructor(scope: Construct, stackID: string) {
    super(scope, {
      // R2ãƒã‚±ãƒƒãƒˆå
      bucket: "example-tfstate",
      // å„tfstateãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚­ãƒ¼
      key: `terraform.${stackID}.tfstate`,
      // ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã¯us-east-1ã‚‚ã—ãã¯autoã‚’æŒ‡å®šã€‚è©³ç´°ã¯S3äº’æ›ã®R2ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚ç…§
      // https://developers.cloudflare.com/r2/api/s3/api/
      region: "us-east-1",
      endpoints: {
        // R2ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã€‚ã‚¢ã‚«ã‚¦ãƒ³ãƒˆIDã¯ã‚³ãƒ³ã‚½ãƒ¼ãƒ« or APIã§å–å¾—
        s3: `https://${CLOUDFLARE_ACCOUNT_ID}.r2.cloudflarestorage.com`,
      },
      // å„ãƒã‚§ãƒƒã‚¯ã‚’ã‚¹ã‚­ãƒƒãƒ—
      skipRegionValidation: true,
      skipCredentialsValidation: true,
      skipRequestingAccountId: true,
      skipS3Checksum: true,
      // AWSã®ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ‡å®š
      profile: "ExampleProfile",
    });
  }
}
```

å„ Stack ã§ `R2Backend` ã‚’å‘¼ã³å‡ºã—ã¦ä½¿ã„ã¾ã™ã€‚

```ts:my-stack.ts
import { provider } from "@cdktf/provider-cloudflare";
import { TerraformStack } from "cdktf";
import { R2Backend } from "./r2-backend";
import type { Construct } from "constructs";

export class MyStack extends TerraformStack {
  constructor(scope: Construct, id: string) {
    super(scope, id);

    new provider.CloudflareProvider(this, "cloudflare");

    new R2Backend(this, id);
  }
}
```

### AWS ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã§èªè¨¼è¨­å®šã‚’è¿½åŠ 

`R2Backend` ã§ AWS ã®ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ‡å®šã—ã¦ã„ã‚‹ã®ã§ã€ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¨­å®šã—ã¦ãŠãã¾ã™ã€‚
ï¼ˆèªè¨¼ã‚’åˆ¥ã®æ–¹æ³•ã§ã‚„ã‚‹ãªã‚‰æŒ‡å®šä¸è¦ï¼‰

ã¾ãšã¯ Cloudflare ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ API ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½œæˆã—ã¾ã™ã€‚

![](/images/cdktf-tfstate/example-api-token.png)

ä½œæˆã—ãŸ API ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ AWS ã®ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã«è¨­å®šã—ã¾ã™ã€‚
`aws configure` ã§è¨­å®šã™ã‚‹ã‚‚ã—ãã¯ `~/.aws/config` ã¨ `~/.aws/credentials` ã«ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¨­å®šã—ã¦ãŠãã¾ã™ã€‚

```sh
# .aws/config
[profile ExampleProfile]
region=auto
```

```sh
# .aws/credentials
[ExampleProfile]
aws_access_key_id = xxxxxxxxxx # ã‚¢ã‚¯ã‚»ã‚¹ ã‚­ãƒ¼ ID
aws_secret_access_key = yyyyyyyyy # ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ ã‚¢ã‚¯ã‚»ã‚¹ ã‚­ãƒ¼
```

ä»¥ä¸Šã§è¨­å®šã¯å®Œäº†ã§ã™ã€‚
ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã¨ tfstate ãŒ R2 ã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã—ãŸï¼

![](/images/cdktf-tfstate/complete.png)

## ã¾ã¨ã‚

Terraform ã§ tfstate ã‚’ç®¡ç†ã™ã‚‹æ–¹æ³•ã®è¨˜äº‹ãŒã‚ã£ãŸã®ã§ã€CDKTF ã§ã‚‚è©¦ã—ã¾ã—ãŸãŒå•é¡Œãªãã§ãã¾ã—ãŸã€‚
Cloudflare ã«ãƒªã‚½ãƒ¼ã‚¹ã‚’å¯„ã›ãŸã„æ–¹ã¯ãœã²è©¦ã—ã¦ã¿ã¦ãã ã•ã„ï¼
