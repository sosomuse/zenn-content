---
title: "CDKTFã§Cloudflareãƒªã‚½ãƒ¼ã‚¹ã®IaCã‚’å®Ÿç¾ã™ã‚‹"
emoji: "ğŸŒ©ï¸"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["terraform", "cloudflare", "cdktf", "typescript"]
published: false
# publication_name: "gemcook"
---

## æ¦‚è¦

CDKTFï¼ˆCloud Development Kit for Terraformï¼‰ã¯ CDK ã®æ¦‚å¿µã‚’ Terraform ã«æŒã¡è¾¼ã‚“ã ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã€TypeScript ã‚„ Python ãªã©ã‚’ä½¿ã£ã¦æ§˜ã€…ãªã‚¯ãƒ©ã‚¦ãƒ‰ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’ç®¡ç†ã§ãã¾ã™ã€‚
AWS ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’ç®¡ç†ã™ã‚‹ãªã‚‰åŸºæœ¬çš„ã« CDK ã§äº‹è¶³ã‚Šã¾ã™ãŒã€CDKTF ã¯ CDK ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã‚’æ´»ã‹ã—ã¤ã¤ AWS ä»¥å¤–ã®ã‚¯ãƒ©ã‚¦ãƒ‰ãƒªã‚½ãƒ¼ã‚¹ç®¡ç†ãŒã§ãã‚‹ã®ã§ CDK ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¯å‡„ããŠã™ã™ã‚ã§ã™ã€‚
ï¼ˆCDKTF ã®é–‹ç™ºã«ã¯ CDK ã®é–‹ç™ºè€…ãƒãƒ¼ãƒ ã‚‚é–¢ã‚ã£ã¦ã„ã‚‹ã®ã§ã€CDK ã¨ã®è¦ªå’Œæ€§ãŒã‹ãªã‚Šé«˜ã„ï¼‰

ã‚ˆã‚Šè©³ã—ã„æƒ…å ±ã¯å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‹ã‚‰ã©ã†ã
https://developer.hashicorp.com/terraform/cdktf

ç§ã‚‚ CDKTF ã§ Cloudflare ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’ç®¡ç†ã—ã¦ IaC åŒ–ã‚’å¿«é©ã«è¡ŒãˆãŸã®ã§ã€ãã®æ‰‹é †ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

## æƒ³å®šèª­è€…

- CDK ã«ã¯è§¦ã‚ŒãŸã“ã¨ãŒã‚ã‚‹ãŒã€Terraform, CDKTF ã«è§¦ã‚ŒãŸã“ã¨ãŒãªã„äºº
- Terraform ä½¿ã„ãŸã„ãŒ HCL ãŒè‹¦æ‰‹ãªäºº

## äº‹å‰æº–å‚™

CDKTF ã® Init ã¯å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«æ›¸ã‹ã‚Œã¦ã„ã‚‹ã®ã§ãã¡ã‚‰ã‚’å‚ç…§ã€‚
CDKTF ã‚‚ CDK ã¨åŒã˜ã TypeScript ãŒãŠã™ã™ã‚ãªã®ã§ã€æœ¬è¨˜äº‹ã§ã¯ TypeScript ã§ã®å®Ÿè£…ã¨ã—ã¾ã™ã€‚

https://developer.hashicorp.com/terraform/tutorials/cdktf/cdktf-install

## Cloudflare Provider ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

CDKTF ã§ã¯å„ Provider ã®å®šç¾©ãŒãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¨ã—ã¦æä¾›ã•ã‚Œã¦ã„ã‚‹ã®ã§ `@cdktf/provider-cloudflare` ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

https://github.com/cdktf/cdktf-provider-cloudflare/tree/de5bb8eb668f25de70e488673dd2af2c8cad947d

```bash
$ npm install @cdktf/provider-cloudflare
```

## R2 ã‚µãƒ³ãƒ—ãƒ«

è©¦ã—ã« R2Bucket ã‚’ä½œæˆã™ã‚‹ã‚µãƒ³ãƒ—ãƒ«ã‚’ç”¨æ„ã—ã¾ã™ã€‚

```typescript:main.ts
import { App } from "cdktf";
import { MyStack } from "./stack/my-stack";

const app = new App();
new MyStack(app, "MyStack");
app.synth();
```

```typescript:stack/my-stack.ts
import { provider, r2Bucket } from "@cdktf/provider-cloudflare";
import { TerraformStack } from "cdktf";
import type { Construct } from "constructs";

const CLOUDFLARE_ACCOUNT_ID = "xxxxxxxxxxxxx";

export class MyStack extends TerraformStack {
  constructor(scope: Construct, id: string) {
    super(scope, id);

    new provider.CloudflareProvider(this, "cloudflare");

    new r2Bucket.R2Bucket(this, "hoge-bucket", {
      accountId: CLOUDFLARE_ACCOUNT_ID,
      name: "hoge-bucket",
    });
  }
}
```

CDK ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¯ãŠãªã˜ã¿ã®è¨˜æ³•ã§ã‚¹ã‚¿ãƒƒã‚¯ã‚’å®šç¾©ã§ãã¾ã™ ğŸš„

### Env ã®è¨­å®š

ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œæˆã™ã‚‹å ´åˆåŸºæœ¬çš„ã«ç’°å¢ƒåˆ†ã‘ã—ãŸããªã‚Šã¾ã™ã­ ğŸ‡
ç’°å¢ƒå¤‰æ•°ã®ç®¡ç†ã¯è‰²ã€…æ–¹æ³•ãŒã‚ã‚Šã¾ã™ãŒã€é€šå¸¸ã®ç’°å¢ƒå¤‰æ•°ã§ã‚ã‚Œã° TypeScript ã®ã‚³ãƒ¼ãƒ‰å†…ã§ç®¡ç†ã—ã¦ã—ã¾ã†ã®ãŒæ¥½ã§ã—ã‚‡ã†ã€‚
ç§ã¯ã“ã‚“ãªæ„Ÿã˜ã§ç®¡ç†ã—ã¦ã¾ã™ã€‚

```typescript:main.ts
function firstUpperCase(str: string): string {
  return str.charAt(0).toUpperCase() + str.slice(1);
}

const app = new App();
const envMap = {
  dev: {},
  stg: {},
  prd: {},
};
[("dev", "stg", "prd")].forEach((env) => {
  const envValues = envMap[env];
  const firstUpperEnv = firstUpperCase(env);
  new MyStack(app, `MyStack-${firstUpperEnv}`, envValues);
});
app.synth();
```

```typescript:stack/my-stack.ts
export class MyStack extends TerraformStack {
  constructor(scope: Construct, id: string, envValues: EnvValues) {
    super(scope, id);

    new provider.CloudflareProvider(this, "cloudflare");

    new r2Bucket.R2Bucket(this, "hoge-bucket", {
      accountId: CLOUDFLARE_ACCOUNT_ID,
      name: "hoge-bucket",
    });
  }
}
```

ç’°å¢ƒåˆ†ã‘ã‚„ç’°å¢ƒå¤‰æ•°ã®å€¤ãŒã‚ã‹ã‚Šã‚„ã™ã„ã®ã‚‚ CDK ç”±æ¥ã®è‰¯ã•ã§ã™ã­ ğŸŒˆ

### èªè¨¼æƒ…å ±ã®è¨­å®š

Cloudflare ã®èªè¨¼æƒ…å ±ã‚’ç’°å¢ƒå¤‰æ•°ã§è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚Cloudflare ã§ã¯ç¾åœ¨ API ãƒˆãƒ¼ã‚¯ãƒ³ãŒæ¨å¥¨ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€ä»¥ä¸‹ã®æ‰‹é †ã§ API ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½œæˆã—ã€ç’°å¢ƒå¤‰æ•°ã«è¨­å®šã—ã¾ã™ã€‚

https://developers.cloudflare.com/fundamentals/api/get-started/create-token/

CLI ä¸Šã§ `export` ã™ã‚‹ã¨ CDKTF ä¸Šã‹ã‚‰å‚ç…§ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```
$ export CLOUDFLARE_API_TOKEN=xxxxxxxxxxxxx
```

### Diff, Deploy, Destroy

Diff, Deploy, Destroy ã¯ CDK ã¨åŒã˜ã§ã™ã­ã€‚
ãŸã ã— CDK ã¨é•ã£ã¦å…¨ã‚¹ã‚¿ãƒƒã‚¯ã® Diff ã‚’å‡ºã™ã‚ˆã†ãªã‚³ãƒãƒ³ãƒ‰ã¯ç”¨æ„ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚

```bash
$ npx cdktf diff STACK=Xxxxx

$ npx cdktf deploy STACK=Xxxxx

$ npx cdktf destroy STACK=Xxxxx
```

## tfstate ã®ç®¡ç†

CDKTF ã¨ CDK ã¨ã®å¤§ããªé•ã„ã®ä¸€ã¤ã« tfstate ã®å­˜åœ¨ãŒã‚ã‚Šã¾ã™ã€‚
tfstate ã¯ Terraform ãŒç®¡ç†ã™ã‚‹ãƒªã‚½ãƒ¼ã‚¹ã®çŠ¶æ…‹ã‚’ä¿å­˜ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã§ã€ã©ã®ã‚¹ã‚¿ãƒƒã‚¯ã§ä½•ã®ãƒªã‚½ãƒ¼ã‚¹ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹ã‹ãªã©ãŒè¨˜éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚

https://developer.hashicorp.com/terraform/cdktf/concepts/remote-backends

ãƒ­ãƒ¼ã‚«ãƒ«ã§ç®¡ç†ã‚‚ã§ãã¾ã™ãŒã€èª¤ã£ã¦æ¶ˆã—ãŸã‚Šã™ã‚‹ã¨ãƒªã‚½ãƒ¼ã‚¹ã®çŠ¶æ…‹ãŒã‚ã‹ã‚‰ãªããªã‚‹ã®ã§ S3 ãªã©ã®ãƒªãƒ¢ãƒ¼ãƒˆã§ä¿å­˜ã™ã‚‹ã“ã¨ãŒæ¨å¥¨ã•ã‚Œã¾ã™ã€‚ï¼ˆå½“ç„¶ãƒãƒ¼ãƒ é–‹ç™ºæ™‚ã«ã¯ãƒªãƒ¢ãƒ¼ãƒˆã§ç®¡ç†ã™ã‚‹ã“ã¨ãŒå¿…é ˆï¼‰

ãƒªãƒ¢ãƒ¼ãƒˆã§ç®¡ç†ã™ã‚‹å ´åˆã€ä¾‹ãˆã° S3 ã«ä¿å­˜ã™ã‚‹ã«ã¯æ¬¡ã®ã‚ˆã†ã«è¨˜è¼‰ã—ã¾ã™ã€‚

```typescript:./stack/my-stack.ts
export class MyStack extends TerraformStack {
  constructor(scope: Construct, id: string) {
    super(scope, id);

    new provider.CloudflareProvider(this, "cloudflare");

    // tfstate ã‚’ S3 ã«ä¿å­˜
    new S3Backend(this, {
      bucket: "tfstate-bucket",
      key: "terraform.tfstate",
      region: "us-east-1",
    });

    new r2Bucket.R2Bucket(this, "hoge-bucket", {
      accountId: CLOUDFLARE_ACCOUNT_ID,
      name: "hoge-bucket",
    });
  }
}
```

â†‘ ã§ã¯ S3 ã«ä¿å­˜ã—ã¦ã„ã¾ã™ãŒã€Cloudflare R2 ã§ç®¡ç†ã™ã‚‹ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚
Diff, Deploy æ™‚ã« AWS ã¸ã®èªè¨¼ãŒç„¡é§„ã«æŒŸã¾ã£ã¦ã—ã¾ã†ã®ã§ã€Cloudflare ã§ä¸€å…ƒç®¡ç†ã—ãŸã‹ã£ãŸã‹ã‚‰ã§ã™ã­ã€‚
R2 ã§ tfstate ã‚’ç®¡ç†ã™ã‚‹æ–¹æ³•ã¯åˆ¥é€”è¨˜äº‹ã«ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚

## ã¾ã¨ã‚

Terraform ã‚’ TypeScript ã§æ›¸ã‘ã‚‹ CDKTF ã¯éå¸¸ã«ä¾¿åˆ©ã§ã™ã€‚AWS ä»¥å¤–ã®ã‚¯ãƒ©ã‚¦ãƒ‰ãƒªã‚½ãƒ¼ã‚¹ã‚‚ç®¡ç†ã§ãã‚‹ãŸã‚ã€ãƒãƒ«ãƒã‚¯ãƒ©ã‚¦ãƒ‰ç’°å¢ƒã§ã®ã‚¤ãƒ³ãƒ•ãƒ©ç®¡ç†ãŒã‚·ãƒ³ãƒ—ãƒ«ã«ãªã‚Šã¾ã™ã€‚CDK ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¨ã£ã¦ã¯ç‰¹ã«ãŠã™ã™ã‚ã®ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚
CDKTF ã¯ã„ã„ãï¼ğŸš€
