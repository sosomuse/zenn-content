---
title: "React18ã§ã¯ setState æ™‚ã®ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯å¯¾ç­–ã¯å¿…è¦ãªã„"
emoji: "ğŸš¨"
type: "tech"
topics: ["javascript", "react", "typescript"]
published: true
---

:::message
ã“ã®è¨˜äº‹ã¯ [React Advent Calendar 2021](https://qiita.com/advent-calendar/2021/react) 12æ—¥ç›®ã®è¨˜äº‹ã§ã™ã€‚
:::

éåŒæœŸå‡¦ç†ã®çµæœãªã©ã«ã‚ˆã£ã¦ unmount ã•ã‚ŒãŸã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ setState ã‚’å®Ÿè¡Œã™ã‚‹ã¨ãŠé¦´æŸ“ã¿ã®è­¦å‘ŠãŒè¡¨ç¤ºã•ã‚Œã¾ã™ãŒã€React18ã‹ã‚‰ã¯è¡¨ç¤ºã•ã‚Œãªããªã‚Šã¾ã™ã€‚

:::message alert
Warning: Can't perform a React state update on an unmounted component. This is a no-op, but it indicates a memory leak in your application. To fix, cancel all subscriptions and asynchronous tasks in a useEffect cleanup function.
:::

## çµè«–

React17ä»¥å‰ã§ã‚‚ã“ã®è­¦å‘Šæ–‡ã«å¯¾ã™ã‚‹å¯¾ç­–ã¯åŸºæœ¬çš„ã«ä¸è¦ãªã®ã§ç„¡è¦–ã—ã¦è‰¯ã„ã€‚
React18ã«ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—ã™ã‚‹ã¨è¡¨ç¤ºã•ã‚Œãªããªã‚‹ã€‚

https://github.com/reactwg/react-18/discussions/82

## è©¦ã—ã¦ã¿ã‚‹

Next.jsã§ã‚µã‚¯ãƒƒã¨React18ã®betaãŒä½¿ãˆã‚‹ã®ã§è©¦ã—ã¦ã¿ã¾ã™ã€‚

https://nextjs.org/docs/advanced-features/react-18#react-18-usage-in-nextjs

ã¾ãšã¯ `react v17.0.2` ã§è­¦å‘Šæ–‡ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãã¾ã™ã€‚
ç”»é¢é·ç§»ã§ä»¥ä¸‹ã®ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè¡Œã™ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’ç”¨æ„ã—ã¾ã™ã€‚

1. 2ç§’å¾Œã« setState ã‚’å®Ÿè¡Œã™ã‚‹ãƒœã‚¿ãƒ³ã‚’ç”¨æ„
2. 2ç§’çµŒã¤å‰ã«ç”»é¢é·ç§»ã§ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ unmount ã™ã‚‹

```tsx:Home.tsx
const Home: NextPage = () => {
  return (
    <div className={styles.container}>
      <h1>Home</h1>
      <Link href="/test">Test</Link>
    </div>
  )
}
```

```tsx:Test.tsx
const sleep = async (ms: number) => {
  return new Promise((resolve) => setTimeout(() => resolve(null), ms));
};

const Test: NextPage = () => {
  const [loading, setLoading] = useState(false);
  const handleClick = useCallback(async () => {
    setLoading(true);
    await sleep(2000);
    setLoading(false);
  }, []);

  return (
    <div className={styles.container}>
      <h1>Test</h1>
      <Link href="/">Home</Link>
      <div>
        <button onClick={handleClick}>Post</button>
      </div>
    </div>
  );
};
```

![react17.0.2](https://storage.googleapis.com/zenn-user-upload/8ee06673ddb0-20211212.gif)

æƒ³å®šé€šã‚Šè­¦å‘Šæ–‡ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
ã§ã¯æ¬¡ã«React18ã§è©¦ã—ã¦ã¿ã¾ã™ã€‚
ç§ãŒæ¤œè¨¼ã—ãŸç’°å¢ƒã¯ `React v18.0.0-beta-24dd07bd2-20211208` ã§ã™ã€‚

```shell
npm install next@latest react@beta react-dom@beta
```

![React18-beta](https://storage.googleapis.com/zenn-user-upload/69662c14fa17-20211212.gif)

è­¦å‘Šæ–‡ãŒè¡¨ç¤ºã•ã‚Œãªã„ã“ã¨ã‚’ç¢ºèªã§ãã¾ã—ãŸã€‚

## è§£èª¬

å…ˆã»ã©ã®issueã«ã‚ˆã‚‹ã¨ã“ã®è­¦å‘Šæ–‡ã¯å…ƒã€…EventListenerãªã©ã®subscribeã«å¯¾ã—ã¦ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å‡¦ç†ã‚’å¿˜ã‚Œã¦ã„ã‚‹ã“ã¨ã«å¯¾ã™ã‚‹è­¦å‘Šã ã£ãŸã‚ˆã†ã§ã™ã€‚

```tsx
useEffect(() => {
  function handleChange() {
     setState(store.getState())
  }
  store.subscribe(handleChange)
  return () => store.unsubscribe(handleChange)
}, [])
```

ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚’å¿˜ã‚Œã¦ã„ã‚‹ã¨ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ã«ç¹‹ãŒã‚Šå¾—ã‚‹ã®ã§ã“ã®è­¦å‘Šæ–‡è‡ªä½“ã¯æ­£ã—ã‹ã£ãŸã®ã§ã™ãŒã€å¤§æŠµã®å ´åˆã¯ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚’å¿˜ã‚Œã‚‹ã‚ˆã‚Šã‚‚ unmount å¾Œã«éåŒæœŸå‡¦ç†ãŒè§£æ±ºã•ã‚Œã‚‹ã“ã¨ã«ã‚ˆã£ã¦è­¦å‘ŠãŒè¡¨ç¤ºã•ã‚Œã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒé »ç™ºã—ã¾ã—ãŸã€‚

ãã†ã—ã¦æœ¬æ¥ã®æ„å›³ãŒèª¤è§£ã•ã‚ŒãŸã¾ã¾ mount çŠ¶æ…‹ã§ãªã‘ã‚Œã° setState ã‚’å®Ÿè¡Œã—ãªã„ã¨ã„ã†è­¦å‘Šã‚’æŠ‘åˆ¶ã™ã‚‹ãŸã‚ã ã‘ã®è§£æ±ºç­–ãŒç”Ÿã¾ã‚Œã¾ã—ãŸã€‚

```tsx
const isMountedRef = useRef(false)
useEffect(() => {
  isMountedRef.current = true
  return () => {
    isMountedRef.current = false
  }
}, [])

const handleClick = useCallback(async () => {
  setLoading(true);
  await someApi();
  if (isMountedRef.current) {
    setLoading(false);
  }
}, []);
```

ã“ã®ã‚ˆã†ãªãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã¯ãã‚‚ãã‚‚ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ã«ç¹‹ãŒã‚‰ãªã„ãŸã‚ mount çŠ¶æ…‹ã‚’ç®¡ç†ã™ã‚‹ã®ã¯ä¸è¦ã§ã‚ã‚Šã€Reactã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—ã«ã‚ˆã£ã¦è­¦å‘Šæ–‡ã‚‚è¡¨ç¤ºã•ã‚Œãªããªã‚Šã¾ã™ã€‚
ãã®ãŸã‚ã€å¯èª­æ€§ã‚’ä¸‹ã’ã¦å°†æ¥çš„ã«ãƒã‚°ã«ç¹‹ãŒã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã‚³ãƒ¼ãƒ‰ã¯æ›¸ã‹ãšã«é™ã‹ã«React18ã‚’å¾…ã¡ã¾ã—ã‚‡ã†ã€‚
